#!/usr/bin/env bash
# config/entra-id.conf - Microsoft Entra ID/Microsoft SSO configuration

# Microsoft Entra ID Tenant Configuration
# Your company's Entra ID Tenant ID (UUID from Azure portal)
DEFAULT_ENTRA_TENANT_ID="c902ee7d-d8f4-44e7-a09e-bf42b25fa285"

# Integration Method
# Options: sssd (recommended), aadds (Entra Domain Services), ssh (SSH only)
DEFAULT_ENTRA_METHOD="sssd"

# Authentication Settings
# Enable offline authentication (cache credentials for offline access)
DEFAULT_ENABLE_OFFLINE_AUTH=true

# Cache timeout in seconds (how long cached credentials are valid)
DEFAULT_ENTRA_CACHE_TIMEOUT=3600

# Home Directory Settings
# Automatically create home directories for Azure AD users
DEFAULT_CREATE_HOME_DIRS=true

# Home directory template (use %u for username, %d for domain)
DEFAULT_HOME_DIR_TEMPLATE="/home/%u"

# Default shell for Entra ID users
DEFAULT_ENTRA_SHELL="/bin/bash"

# User/Group Settings
# Use short names (username) instead of full (username@domain)
DEFAULT_USE_SHORT_NAMES=true

# Enumerate users and groups (set to false for large domains)
DEFAULT_ENUMERATE_USERS=false

# Access Control
# GPO access control mode: enforcing, permissive, or disabled
DEFAULT_GPO_ACCESS_CONTROL="permissive"

# Allow/deny specific groups (comma-separated)
ENTRA_ALLOW_GROUPS=""
ENTRA_DENY_GROUPS=""

# Kerberos Settings
# Ticket lifetime
DEFAULT_KRB5_TICKET_LIFETIME="24h"

# Renewable ticket lifetime
DEFAULT_KRB5_RENEWABLE_LIFETIME="7d"

# DNS Settings
# DNS servers for Entra ID (will be auto-detected if empty)
ENTRA_DNS_SERVERS=""

# Time Sync Settings
# NTP servers for time synchronization
ENTRA_NTP_SERVERS="time.windows.com pool.ntp.org"

# Backup Settings
# Directory to store configuration backups
ENTRA_BACKUP_DIR="/etc/azure-ad-backup"

# Keep this many backup versions
ENTRA_BACKUP_RETENTION=5

# Debug Settings
# SSSD debug level (0-10, 0=disabled)
ENTRA_DEBUG_LEVEL=0

# Save debug logs to file
ENTRA_DEBUG_LOG="/var/log/azure-ad-setup.log"

# Advanced Settings
# LDAP referrals (usually false for Entra ID)
ENTRA_LDAP_REFERRALS=false

# Use LDAPS (LDAP over SSL)
ENTRA_USE_LDAPS=false

# Dynamic DNS updates
ENTRA_DYNDNS_UPDATE=false

# ID mapping (map SIDs to UIDs/GIDs)
ENTRA_ID_MAPPING=true

# Integration Features
# Enable SSH key retrieval from Entra ID
ENTRA_SSH_KEYS=false

# Enable sudo rules from Entra ID
ENTRA_SUDO_RULES=false

# Performance Tuning
# Entry cache timeout (seconds)
ENTRA_CACHE_ENTRY_TIMEOUT=300

# Offline credentials expiration (days)
ENTRA_OFFLINE_CREDENTIALS_EXPIRATION=7

# Connection retries
ENTRA_RECONNECTION_RETRIES=3

# Testing Configuration
# Test user for validation (optional)
ENTRA_TEST_USER=""

# Skip certain tests during setup
ENTRA_SKIP_DNS_TEST=false
ENTRA_SKIP_TIME_TEST=false
ENTRA_SKIP_NETWORK_TEST=false

# Function to validate Microsoft Entra ID configuration
validate_entra_config() {
  local errors=()
  
  # Check tenant ID format (UUID)
  if [[ ! "$DEFAULT_ENTRA_TENANT_ID" =~ ^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$ ]]; then
    errors+=("Invalid Tenant ID format: $DEFAULT_ENTRA_TENANT_ID")
  fi
  
  # Check method
  if [[ ! "$DEFAULT_ENTRA_METHOD" =~ ^(sssd|aadds|ssh)$ ]]; then
    errors+=("Invalid method: $DEFAULT_ENTRA_METHOD")
  fi
  
  # Check GPO mode
  if [[ ! "$DEFAULT_GPO_ACCESS_CONTROL" =~ ^(enforcing|permissive|disabled)$ ]]; then
    errors+=("Invalid GPO mode: $DEFAULT_GPO_ACCESS_CONTROL")
  fi
  
  # Check debug level
  if [[ "$ENTRA_DEBUG_LEVEL" -lt 0 ]] || [[ "$ENTRA_DEBUG_LEVEL" -gt 10 ]]; then
    errors+=("Invalid debug level: $ENTRA_DEBUG_LEVEL (must be 0-10)")
  fi
  
  if [[ ${#errors[@]} -gt 0 ]]; then
    for error in "${errors[@]}"; do
      echo "Configuration error: $error" >&2
    done
    return 1
  fi
  
  return 0
}

# Export configuration
export DEFAULT_ENTRA_TENANT_ID DEFAULT_ENTRA_METHOD
export DEFAULT_ENABLE_OFFLINE_AUTH DEFAULT_CREATE_HOME_DIRS
export DEFAULT_USE_SHORT_NAMES DEFAULT_ENUMERATE_USERS
export DEFAULT_GPO_ACCESS_CONTROL
export ENTRA_BACKUP_DIR ENTRA_DEBUG_LEVEL